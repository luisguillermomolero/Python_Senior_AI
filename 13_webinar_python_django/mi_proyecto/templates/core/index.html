{% extends 'core/base.html' %} {% block content %}
<h1>Lista de Tareas</h1>
<div id="alert-placeholder"></div>
<button class="btn btn-primary mb-3" id="btn-new">Nueva tarea</button>
<table class="table table-striped">
  <thead>
    <tr>
      <th>ID</th>
      <th>TÃ­tulo</th>
      <th>Completada</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody id="tasks-body"></tbody>
</table>

<div class="modal fade" id="taskModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Nueva tarea</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <form id="taskForm">
          <input type="hidden" id="taskId" />
          <div class="mb-3">
            <label for="title">TÃ­tulo</label>
            <input id="title" class="form-control" required />
          </div>
          <div class="mb-3">
            <label for="description">DescripciÃ³n</label>
            <textarea id="description" class="form-control"></textarea>
          </div>
          <div class="form-check">
            <input type="checkbox" id="completed" class="form-check-input" />
            <label class="form-check-label" for="completed">Completada</label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cerrar
        </button>
        <button type="button" class="btn btn-primary" id="saveBtn">
          Guardar
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // ðŸ”¹ URL base de la API REST (definida en Django REST Framework)
  // AquÃ­ apuntamos al endpoint /api/tasks/ para consumir los datos
  const apiBase = "/api/tasks/";

  // ==============================================================
  // ðŸ§© FunciÃ³n para obtener todas las tareas (READ)
  // ==============================================================
  async function fetchTasks() {
    // Realiza una peticiÃ³n GET a la API
    const res = await fetch(apiBase);
    // Convierte la respuesta a formato JSON
    const data = await res.json();

    // Selecciona el cuerpo de la tabla donde se mostrarÃ¡n las tareas
    const body = document.getElementById("tasks-body");
    // Limpia el contenido previo antes de renderizar nuevamente
    body.innerHTML = "";

    // Recorre todas las tareas recibidas desde el backend
    data.forEach((t) => {
      // Crea una fila <tr> para la tabla
      const tr = document.createElement("tr");
      // Inserta el contenido HTML de la fila con los datos de la tarea
      tr.innerHTML = `
      <td>${t.id}</td>
      <td>${t.title}</td>
      <td>${t.completed ? "SÃ­" : "No"}</td>
      <td>
        <button class="btn btn-sm btn-info" onclick="editTask(${
          t.id
        })">Editar</button>
        <button class="btn btn-sm btn-danger" onclick="deleteTask(${
          t.id
        })">Eliminar</button>
      </td>`;
      // Agrega la fila al cuerpo de la tabla
      body.appendChild(tr);
    });
  }

  // ==============================================================
  // ðŸ§© Crear nueva tarea (CREATE)
  // ==============================================================
  async function createTask(payload) {
    await fetch(apiBase, {
      method: "POST", // MÃ©todo HTTP POST para crear
      headers: { "Content-Type": "application/json" }, // Indicamos formato JSON
      body: JSON.stringify(payload), // Convertimos el objeto a JSON
    });
  }

  // ==============================================================
  // ðŸ§© Actualizar una tarea existente (UPDATE)
  // ==============================================================
  async function updateTask(id, payload) {
    await fetch(`${apiBase}${id}/`, {
      method: "PUT", // MÃ©todo HTTP PUT para actualizar
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });
  }

  // ==============================================================
  // ðŸ§© Eliminar tarea (DELETE)
  // ==============================================================
  async function deleteTask(id) {
    // Confirma antes de eliminar
    if (!confirm("Â¿Eliminar tarea?")) return;
    await fetch(`${apiBase}${id}/`, { method: "DELETE" });
    // Vuelve a cargar la lista de tareas
    fetchTasks();
  }

  // ==============================================================
  // ðŸ§© Mostrar alertas temporales (Bootstrap)
  // ==============================================================
  function showAlert(message, type = "success") {
    const p = document.getElementById("alert-placeholder");
    // Inserta un mensaje de alerta dinÃ¡mico en el contenedor
    p.innerHTML = `<div class="alert alert-${type}" role="alert">${message}</div>`;
    // Borra el mensaje despuÃ©s de 3 segundos
    setTimeout(() => (p.innerHTML = ""), 3000);
  }

  // ==============================================================
  // ðŸ§© Manejo del modal (Bootstrap)
  // ==============================================================
  const modal = new bootstrap.Modal(document.getElementById("taskModal"));

  // Cuando se hace clic en el botÃ³n â€œNueva tareaâ€
  document.getElementById("btn-new").addEventListener("click", () => {
    document.getElementById("modalTitle").innerText = "Nueva tarea"; // Cambia tÃ­tulo del modal
    document.getElementById("taskId").value = ""; // Limpia ID
    document.getElementById("taskForm").reset(); // Limpia formulario
    modal.show(); // Muestra el modal
  });

  // ==============================================================
  // ðŸ§© Cargar datos en el modal para editar tarea existente
  // ==============================================================
  async function editTask(id) {
    const res = await fetch(`${apiBase}${id}/`); // Pide datos de la tarea
    const t = await res.json(); // Convierte la respuesta en JSON

    // Rellena los campos del formulario con los datos existentes
    document.getElementById("taskId").value = t.id;
    document.getElementById("title").value = t.title;
    document.getElementById("description").value = t.description;
    document.getElementById("completed").checked = t.completed;

    document.getElementById("modalTitle").innerText = "Editar tarea"; // Cambia tÃ­tulo del modal
    modal.show(); // Muestra el modal
  }

  // ==============================================================
  // ðŸ§© Guardar tarea (crear o actualizar)
  // ==============================================================
  document.getElementById("saveBtn").addEventListener("click", async () => {
    // Obtiene el ID (vacÃ­o si es una tarea nueva)
    const id = document.getElementById("taskId").value;

    // Construye el objeto de datos a enviar
    const payload = {
      title: document.getElementById("title").value,
      description: document.getElementById("description").value,
      completed: document.getElementById("completed").checked,
    };

    try {
      // Si hay ID â†’ actualizar, si no â†’ crear nueva
      if (id) await updateTask(id, payload);
      else await createTask(payload);

      modal.hide(); // Cierra el modal
      showAlert("Guardado correctamente"); // Muestra mensaje de Ã©xito
      fetchTasks(); // Recarga la lista
    } catch (err) {
      showAlert("Error al guardar", "danger"); // Muestra mensaje de error
    }
  });

  // ==============================================================
  // ðŸ§© InicializaciÃ³n
  // Llama a fetchTasks() apenas se carga la pÃ¡gina
  // ==============================================================
  fetchTasks();
</script>
{% endblock %}
